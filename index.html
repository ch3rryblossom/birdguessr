<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirdGuessr</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
</head>

<style>
  /* ===== COLOR SCHEME ===== */
  :root {
    --bg-dark-green: #1a3a2e;
    --bg-medium-green: #2d5a45;
    --bg-light-green: #3d6b55;
    
    --accent-gold: #d4af37;
    --accent-light-gold: #f0d98c;
    --accent-bronze: #b8860b;
    
    --text-cream: #f5e6d3;
    --text-light-cream: #faf5ee;
    --text-gold: #e8c478;
    
    --border-gold: #c9a961;
    --shadow-dark: rgba(0, 0, 0, 0.4);
  }

    @font-face {
    font-family: 'Blox BRK';
    src: url("assets/fonts/blox-brk.regular.ttf");
    }
    @font-face {
    font-family: 'Pica Hole';
    src: url("assets/fonts/pica-hole.mrt.ttf");
    }
    @font-face {
    font-family: 'So So Sue Me';
    src: url("assets/fonts/so.so-sue-me.ttf");
    }
    @font-face {
    font-family: 'Pixel Operator';
    src: url("assets/fonts/PixelOperator.ttf");
    }

  #pageTitle {
  /* font-family: "Blox BRK"; could be? is interesting at least */
  font-family: "So So Sue Me";
}

body {
  font-family: "Pixel Operator"; 
  font-size: 1.2em;
  /* font-family: "Blox BRK"; could actually be very cool for some sections */
  /* font-family: "Pica Hole"; actually seems pretty good for the start game button! */

  background: linear-gradient(135deg, var(--bg-dark-green) 0%, var(--bg-medium-green) 50%, var(--bg-dark-green) 100%);
  background-attachment: fixed;
}
  
  /* Scrollbar styling */
  #homeBar, #gameBar {
    scrollbar-width: thin;                 
    scrollbar-color: var(--accent-bronze) transparent;
    scrollbar-gutter: stable;
  }

  #homeBar::-webkit-scrollbar,
  #gameBar::-webkit-scrollbar {
    width: 8px;
  }
  #homeBar::-webkit-scrollbar-track,
  #gameBar::-webkit-scrollbar-track {
    background: transparent;
  }
  #homeBar::-webkit-scrollbar-thumb,
  #gameBar::-webkit-scrollbar-thumb {
    background: var(--accent-bronze);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }
  #homeBar:hover::-webkit-scrollbar-thumb,
  #gameBar:hover::-webkit-scrollbar-thumb {
    background: var(--accent-gold);
    background-clip: padding-box;
  }

  /* "vintage" glow border effect */
  .vintage-border {
    border: 3px double var(--border-gold);
    box-shadow: 
      inset 0 0 0 1px var(--accent-bronze),
      0 4px 12px var(--shadow-dark);
  }

  .vintage-button {
    background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-light-gold) 100%);
    border: 2px solid var(--accent-light-gold);
    box-shadow: 0 4px 8px var(--shadow-dark);
    color: var(--bg-dark-green);
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
  }

  #startGameBtn {
    font-family: "Pica Hole";
    color: black;
  }

  .vintage-button:hover {
    background: linear-gradient(135deg, var(--accent-bronze) 0%, var(--accent-gold) 100%);
    box-shadow: 0 6px 16px var(--shadow-dark);
    transform: translateY(-2px);
  }

  .vintage-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  #homeBtn {
    transition: all 0.3s ease;
    background: rgba(61, 107, 85, 0.8);
  }
  #homeBtn:hover {
    transform: translateY(-2px);
    background: rgba(112, 155, 135, 0.6);
  }

  .accordion-item {
    background: rgba(45, 90, 69, 0.6);
    border: 2px solid var(--accent-bronze);
    transition: all 0.3s ease;
  }

  .accordion-item:hover {
    background: rgba(61, 107, 85, 0.8);
    border-color: var(--accent-gold);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
  }

  .accordion-body {
    color: var(--text-cream);
  }

  /* glow text shadow for headers */
  .glow-text {
    text-shadow: 
      2px 2px 4px rgba(0, 0, 0, 0.6),
      0 0 20px rgba(212, 175, 55, 0.4);
  }

  .roundEndInfo--visible {
    opacity: 1 !important;
    transform: scale(1) !important;
    pointer-events: auto !important;
  }
#birdsHeader {
  padding-bottom: 2px;
  border-bottom: 2px solid transparent;
  transition: border-bottom-color 0.3s ease-in-out;
}

.birdsHeader--scrolled {
  border-bottom-width: 2px !important;
  border-bottom-color: rgba(255, 215, 0, 0.6) !important;
}

@keyframes fadeSlideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.birdItem {
  opacity: 0;
  animation: fadeSlideIn 0.2s ease-out forwards;
}
.bird-lastword {
  color: var(--text-cream);
}

.leaflet-popup-content-wrapper {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    margin-bottom: -13px !important;
}

.leaflet-popup-tip {
    background: #f0d98c !important;
}

.popup-confirm-btn {
    background: linear-gradient(135deg, #b8860b 0%, #d4af37 100%);
    border: 2px solid #f0d98c;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    color: #1a3a2e;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-family: 'Pixel Operator', sans-serif;
    transition: all 0.5s ease-in-out;
}

.popup-confirm-btn:hover {
    background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-light-gold) 100%);
}

/* Sliding rhombus animation */
@keyframes slideRhombus {
    0% {
        left: -150px;
        opacity: 0;
    }
    15% {
        opacity: 0.15;
    }
    85% {
        opacity: 0.15;
    }
    100% {
        left: calc(100% + 150px);
        opacity: 0;
    }
}

#roundEndInfo::before {
    content: '';
    position: absolute;
    width: 200px;
    height: 200%;
    background: rgba(255, 255, 255, 0.6);
    transform: skewX(-20deg);
    animation: slideRhombus 0.7s ease-in-out forwards;
    pointer-events: none;
    z-index: -1;
}

#roundEndInfo {
    position: relative;
    overflow: hidden;
}

</style>

<body class="min-h-screen">
    <!-- Homepage -->
    <div id="homePage" class="min-h-screen flex flex-row">
        <!-- Homepage Sidebar -->
        <div id="homeBar" class="w-80 p-2 vintage-border border-r-4 flex flex-col items-center h-screen overflow-y-auto" style="background: rgba(26, 58, 46, 0.9);">
            <h1 id="pageTitle" class="glow-text text-5xl font-bold p-8" style="color: var(--accent-light-gold);">
                BirdGuessr
            </h1>
            <p class="p-4 text-xl text-center" style="color: var(--text-cream);">
                Guess where the 
                <a href="https://ebird.org/home" class="no-underline hover:underline" style="color: var(--accent-gold);">
                    <span style="color: var(--accent-gold);">e</span><span style="color: var(--text-light-cream);">Bird</span>
                </a> 
                entry was made!
            </p>
            <div class="mt-2 w-5/6 space-y-3">
                <div class="accordion-item rounded-xl overflow-hidden" style="color: var(--text-light-cream);">
                    <button class="accordion-header w-full flex items-center gap-2 text-left p-4 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-question" viewBox="0 0 16 16" style="color: var(--accent-gold);">
                            <path d="M8.05 9.6c.336 0 .504-.24.554-.627.04-.534.198-.815.847-1.26.673-.475 1.049-1.09 1.049-1.986 0-1.325-.92-2.227-2.262-2.227-1.02 0-1.792.492-2.1 1.29A1.7 1.7 0 0 0 6 5.48c0 .393.203.64.545.64.272 0 .455-.147.564-.51.158-.592.525-.915 1.074-.915.61 0 1.03.446 1.03 1.084 0 .563-.208.885-.822 1.325-.619.433-.926.914-.926 1.64v.111c0 .428.208.745.585.745"/>
                            <path d="m10.273 2.513-.921-.944.715-.698.622.637.89-.011a2.89 2.89 0 0 1 2.924 2.924l-.01.89.636.622a2.89 2.89 0 0 1 0 4.134l-.637.622.011.89a2.89 2.89 0 0 1-2.924 2.924l-.89-.01-.622.636a2.89 2.89 0 0 1-4.134 0l-.622-.637-.89.011a2.89 2.89 0 0 1-2.924-2.924l.01-.89-.636-.622a2.89 2.89 0 0 1 0-4.134l.637-.622-.011-.89a2.89 2.89 0 0 1 2.924-2.924l.89.01.622-.636a2.89 2.89 0 0 1 4.134 0l-.715.698a1.89 1.89 0 0 0-2.704 0l-.92.944-1.32-.016a1.89 1.89 0 0 0-1.911 1.912l.016 1.318-.944.921a1.89 1.89 0 0 0 0 2.704l.944.92-.016 1.32a1.89 1.89 0 0 0 1.912 1.911l1.318-.016.921.944a1.89 1.89 0 0 0 2.704 0l.92-.944 1.32.016a1.89 1.89 0 0 0 1.911-1.912l-.016-1.318.944-.921a1.89 1.89 0 0 0 0-2.704l-.944-.92.016-1.32a1.89 1.89 0 0 0-1.912-1.911z"/>
                            <path d="M7.001 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0"/>
                        </svg>
                        How to Play
                    </button>
                    <div class="accordion-body max-h-0 text-sm transition-all duration-500 ease-in-out">
                        <div class="px-4 pt-2 pb-4" style="color: var(--text-cream);">
                            You'll be shown the list of birds and the date of entry from a random eBird submission. Use the map to select your guess! 
                            <br><br>You'll be awarded points based on how close you were.
                        </div>
                    </div>
                </div>

                <div class="accordion-item rounded-xl overflow-hidden" style="color: var(--text-light-cream);">
                    <button class="accordion-header w-full flex items-center gap-2 text-left p-4 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16" style="color: var(--accent-gold);">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                        </svg>
                        Settings
                    </button>
                    <div class="accordion-body max-h-0 text-sm transition-all duration-500 ease-in-out">
                        <div class="px-4 pt-2 pb-4">Preferences, theme, and controls? (coming "soon")</div>
                    </div>
                </div>

                <div class="accordion-item rounded-xl overflow-hidden" style="color: var(--text-light-cream);">
                    <button class="accordion-header w-full flex items-center gap-2 text-left p-4 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-joystick" viewBox="0 0 16 16" style="color: var(--accent-gold);">
                            <path d="M10 2a2 2 0 0 1-1.5 1.937v5.087c.863.083 1.5.377 1.5.726 0 .414-.895.75-2 .75s-2-.336-2-.75c0-.35.637-.643 1.5-.726V3.937A2 2 0 1 1 10 2"/>
                            <path d="M0 9.665v1.717a1 1 0 0 0 .553.894l6.553 3.277a2 2 0 0 0 1.788 0l6.553-3.277a1 1 0 0 0 .553-.894V9.665c0-.1-.06-.19-.152-.23L9.5 6.715v.993l5.227 2.178a.125.125 0 0 1 .001.23l-5.94 2.546a2 2 0 0 1-1.576 0l-5.94-2.546a.125.125 0 0 1 .001-.23L6.5 7.708l-.013-.988L.152 9.435a.25.25 0 0 0-.152.23"/>
                        </svg>  
                        Game Modes
                    </button>
                    <div class="accordion-body max-h-0 text-sm transition-all duration-500 ease-in-out">
                        <div class="px-4 pt-2 pb-4">Different modes? (coming "soon")</div>
                    </div>
                </div>

                <div class="accordion-item rounded-xl overflow-hidden" style="color: var(--text-light-cream);">
                    <button class="accordion-header w-full flex items-center gap-2 text-left p-4 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16" style="color: var(--accent-gold);">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                        </svg>
                        Login
                    </button>
                    <div class="accordion-body max-h-0 text-sm transition-all duration-500 ease-in-out">
                        <div class="px-4 pt-2 pb-4">Login form here etc, the [Login] above changes to username display once logged in. (coming "late")</div>
                    </div>
                </div>

                <div class="accordion-item rounded-xl overflow-hidden" style="color: var(--text-light-cream);">
                    <button class="accordion-header w-full flex items-center gap-2 text-left p-4 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-stars relative top-0.5" viewBox="0 0 16 16" style="color: var(--accent-gold);">
                            <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5"/>
                            <path d="M2.242 2.194a.27.27 0 0 1 .516 0l.162.53c.035.115.14.194.258.194h.551c.259 0 .37.333.164.493l-.468.363a.28.28 0 0 0-.094.3l.173.569c.078.256-.213.462-.423.3l-.417-.324a.27.27 0 0 0-.328 0l-.417.323c-.21.163-.5-.043-.423-.299l.173-.57a.28.28 0 0 0-.094-.299l-.468-.363c-.206-.16-.095-.493.164-.493h.55a.27.27 0 0 0 .259-.194zm0 4a.27.27 0 0 1 .516 0l.162.53c.035.115.14.194.258.194h.551c.259 0 .37.333.164.493l-.468.363a.28.28 0 0 0-.094.3l.173.569c.078.255-.213.462-.423.3l-.417-.324a.27.27 0 0 0-.328 0l-.417.323c-.21.163-.5-.043-.423-.299l.173-.57a.28.28 0 0 0-.094-.299l-.468-.363c-.206-.16-.095-.493.164-.493h.55a.27.27 0 0 0 .259-.194zm0 4a.27.27 0 0 1 .516 0l.162.53c.035.115.14.194.258.194h.551c.259 0 .37.333.164.493l-.468.363a.28.28 0 0 0-.094.3l.173.569c.078.255-.213.462-.423.3l-.417-.324a.27.27 0 0 0-.328 0l-.417.323c-.21.163-.5-.043-.423-.299l.173-.57a.28.28 0 0 0-.094-.299l-.468-.363c-.206-.16-.095-.493.164-.493h.55a.27.27 0 0 0 .259-.194z"/>
                        </svg>
                        Leaderboard
                    </button>
                    <div class="accordion-body max-h-0 text-sm transition-all duration-500 ease-in-out">
                        <div class="px-4 pt-2 pb-4">Top scorers globally? (coming "late")</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Homepage Main -->
        <div id="homeContent" class="flex-1 flex items-center justify-center relative overflow-hidden">
            <!-- Particles container -->
            <div id="particles-js" class="absolute inset-0 -z-10"></div>

            <div class="p-10 text-center space-y-4 relative z-10">
                <button id="startGameBtn" class="vintage-button py-4 px-12 rounded-lg text-2xl">
                    START<span style="font-family:Pixel Operator;"> &nbsp; </span>GAME
                </button>
            </div>
        </div>
    </div>

    
<script>
    /* Initialize Particles.js */
    particlesJS('particles-js', {
        particles: {
            number: { value: 160, density: { enable: true, value_area: 800 } },
            color: { value: '#d4af37' }, // gold
            shape: { type: 'circle' },
            opacity: { value: 0.7, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: false },
            move: {
                enable: true,
                speed: 1.5,
                direction: 'none',
                random: true,
                straight: false,
                out_mode: 'out',
                bounce: false
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'repulse' },
                onclick: { enable: false },
                resize: true
            },
            modes: {
                repulse: { distance: 100, duration: 0.4 }
            }
        },
        retina_detect: true
    });
</script>
<script>
    // Accordion functionality
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const accordionItem = header.parentElement;
            const accordionBody = accordionItem.querySelector('.accordion-body');
            const isOpen = accordionBody.style.maxHeight && accordionBody.style.maxHeight !== '0px';
            
            // Close all accordions
            document.querySelectorAll('.accordion-body').forEach(body => {
                body.style.maxHeight = '0px';
            });
            
            // Open clicked accordion if it was closed
            if (!isOpen) {
                accordionBody.style.maxHeight = accordionBody.scrollHeight + 'px';
            }
        });
    });
</script>
    <!-- Gamepage -->
    <div id="gamePage" class="min-h-screen flex flex-row">
        <!-- Gamepage Sidebar -->
        <div id="gameBar" class="pl-2 py-4 h-screen overflow-y-auto flex flex-col w-80 vintage-border border-r-4" style="background: rgba(26, 58, 46, 0.95); color: var(--text-light-cream);">
            <div id="gameInfo" class="shrink-0 pb-2 text-center">
                <h2 class="text-4xl font-semibold mb-1 glow-text" style="color: var(--accent-light-gold);">
                    Round <span id="roundNumber">1</span>/<span id="totalRounds">5</span>
                </h2>
                <p class="text-2xl" style="color: var(--text-cream);">Total Score: <span id="totalScore" class="text-2xl font-semibold" style="color: var(--accent-gold);">0</span></p>
            </div>
            <div id="birdInfo" class="pl-2 flex-1 overflow-y-auto space-y-4">
                <div class="relative">
                    <h3 id="birdsHeader"
                        class="font-semibold text-xl mb-2 sticky top-0 z-10" style="background: rgba(26, 58, 46, 0.85); color: var(--accent-light-gold);">
                        Birds Spotted:
                    </h3>
                    <div id="birdList" class="text-lg">
                        <p style="color: var(--text-cream);">Loading...</p>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-1" style="color: var(--accent-light-gold);">Date:</h4>
                    <p id="birdDate" style="color: var(--text-cream);">Loading...</p>
                </div>
                <!-- <div>
                    <h4 class="font-semibold mb-1" style="color: var(--accent-light-gold);">Location:</h4>
                    <p id="birdLocation" style="color: var(--text-cream);">Loading...</p>
                </div> -->
            </div>

            <div class="px-4 shrink-0 mt-4 pt-2" style="border-top: 2px solid var(--accent-bronze);">
                <p class="text-lg mb-4" style="color: var(--text-cream);">
                    Click on the map where you think this bird was spotted!
                </p>
                <button id="homeBtn" class="w-full font-medium py-2 px-4 rounded transition-colors" style="color: var(--text-light-cream); border: 2px solid var(--accent-bronze);">
                    Back to Home
                </button>
            </div>
        </div>
        
        <!-- Gamepage Main -->
        <div id="gameContent" class="flex-1 relative">
            <div id="map" class="w-full h-full"></div>

            <!-- Overlay -->
            <div id="gameOverlay" class="hidden absolute inset-0 bg-black bg-opacity-50 flex justify-center pointer-events-none" style="z-index:1000;">
                <!-- Modal inside overlay -->
                <div id="roundEndInfo"
                    class="rounded-lg p-8 w-full h-1/6 shadow-xl flex items-center justify-around pointer-events-auto vintage-border transition-all duration-250 ease-in-out transform opacity-0 scale-95"
                    style="background: rgba(26, 58, 46, 0.95);">

                    <!-- Box 1: Title -->
                    <div class="flex-1 text-center">
                        <h3 class="text-2xl font-semibold glow-text" style="color: var(--accent-light-gold);">
                            Round Complete!
                        </h3>
                    </div>

                    <!-- Box 2: Distance -->
                    <div class="flex-1 text-center" style="color: var(--text-light-cream);">
                        <p>Distance:</p>
                        <p id="roundDistance" class="font-semibold text-2xl" style="color: var(--accent-gold);">0 km</p>
                    </div>

                    <!-- Box 3: Round + Total Score -->
                    <div class="flex-1 text-center space-y-2" style="color: var(--text-light-cream);">
                        <p class="text-3xl">Round Score: <span id="roundScore" class="font-semibold text-3xl" style="color: var(--accent-light-gold);">500</span></p>
                        <p>Total Score: <span id="overlayTotalScore" class="font-semibold text-xl" style="color: var(--accent-gold);">500</span></p>
                    </div>

                    <!-- Box 4: Button -->
                    <div class="flex-1 flex items-center justify-center">
                        <button id="nextRoundBtn" class="vintage-button text-xl font-bold py-3 px-6 rounded-lg">
                            Next Round
                        </button>
                    </div>
                </div>
            </div>


        </div>
    </div>

   <script>
/* ---------- CONFIG / STORAGE KEYS ---------- */
const STORAGE_KEYS = {
  DAILY_META: 'birdguessr_daily_meta',     // { date: 'YYYY-MM-DD', entries: [...], usedIds: [...] }
  USED_IDS: 'birdguessr_used_ids',         // array of used entry ids across days
  GAME_STATE_PREFIX: 'birdguessr_game_state_' // per-day game state suffix with date
};

const ROUNDS_PER_DAY = 5;

/* ---------- STATE ---------- */
let currentRound = 1;
const totalRounds = ROUNDS_PER_DAY;

let totalScore = 0;
let roundScores = [];
let currentBird = null;
let map = null;
let playerMarker = null;
let actualMarker = null;
let resultLine = null;
let gameState = 'waiting';
let csvData = [];

let dailyEntries = []; // the 5 selected entries for today
let todayStr = (new Date()).toISOString().slice(0,10); // YYYY-MM-DD

/* ---------- UTIL ---------- */
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function makeEntryId(entry) {
  // deterministic ID based on lat, long, date and species (use what you have)
  const lat = entry.lat ?? entry.latitude ?? '';
  const lng = entry.long ?? entry.lng ?? entry.longitude ?? '';
  const date = entry.date ?? '';
  const species = entry.species ?? '';
  return `${lat}|${lng}|${date}|${species}`;
}

function getCountryCode(entry) {
  // tries several likely column names; add more if your CSV uses a different header
  return entry.country_code || entry['country code'] || entry.countrycode || entry.country || entry.iso_country || entry.iso;
}

/* ---------- PERSISTENCE ---------- */
function loadJSON(key, def) {
  try {
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : def;
  } catch (e) {
    console.warn('loadJSON error', e);
    return def;
  }
}
function saveJSON(key, obj) {
  try { localStorage.setItem(key, JSON.stringify(obj)); } catch (e) { console.warn('saveJSON error', e); }
}

/* ---------- DAILY SEQUENCE / SAMPLING ---------- */
function pickDailyEntries(data, requiredN = ROUNDS_PER_DAY) {
  // Exclude rows with missing coords or missing country
  const usable = data.filter(row => {
    const lat = parseFloat(row.lat);
    const lng = parseFloat(row.long ?? row.lng);
    const country = getCountryCode(row);
    return !isNaN(lat) && !isNaN(lng) && country;
  });

  // load global usedIds history
  let usedIds = loadJSON(STORAGE_KEYS.USED_IDS, []);
  const usedSet = new Set(usedIds);

  // Filter out already-used entries
  let candidates = usable.filter(r => !usedSet.has(makeEntryId(r)));

  // If not enough candidates remain, clear usedIds (fallback) and use full set.
  if (candidates.length < requiredN) {
    // Resetting usedIds because dataset exhausted
    usedIds = [];
    saveJSON(STORAGE_KEYS.USED_IDS, usedIds);
    candidates = usable.slice();
  }

  // We want distinct country codes. Group by country.
  const byCountry = {};
  for (const r of candidates) {
    const cc = String(getCountryCode(r)).toUpperCase();
    if (!byCountry[cc]) byCountry[cc] = [];
    byCountry[cc].push(r);
  }

  // For reproducibility across the day, shuffle country list and pick one entry per country
  const countries = shuffle(Object.keys(byCountry));
  const selection = [];
  for (const cc of countries) {
    if (selection.length >= requiredN) break;
    const choices = byCountry[cc];
    const picked = choices[Math.floor(Math.random() * choices.length)];
    selection.push(picked);
  }

  // If still not enough (rare), fill from leftover candidates (distinctness best-effort)
  if (selection.length < requiredN) {
    const leftover = candidates.filter(c => !selection.includes(c));
    shuffle(leftover);
    while (selection.length < requiredN && leftover.length > 0) {
      selection.push(leftover.pop());
    }
  }

  // If still not enough (very small datasets), allow repeats from the full dataset
  if (selection.length < requiredN) {
    const all = usable.slice();
    shuffle(all);
    while (selection.length < requiredN && all.length > 0) {
      selection.push(all.pop());
    }
  }

  // mark these IDs as used now (so future days avoid them)
  const newUsedIds = usedIds.slice();
  for (const e of selection) {
    newUsedIds.push(makeEntryId(e));
  }
  saveJSON(STORAGE_KEYS.USED_IDS, newUsedIds);

  return selection.slice(0, requiredN);
}

function ensureDailyEntries(data) {
  // daily meta stores { date: 'YYYY-MM-DD', entries: [rows... ] }
  const meta = loadJSON(STORAGE_KEYS.DAILY_META, null);

  if (meta && meta.date === todayStr && Array.isArray(meta.entries) && meta.entries.length === ROUNDS_PER_DAY) {
    // use today's saved entries
    dailyEntries = meta.entries;
    return;
  }

  // pick new set for today
  const entries = pickDailyEntries(data, ROUNDS_PER_DAY);

  // Save meta
  const newMeta = { date: todayStr, entries: entries };
  saveJSON(STORAGE_KEYS.DAILY_META, newMeta);
  dailyEntries = entries;
}

/* ---------- GAME STATE PERSISTENCE (per-day) ---------- */
function loadTodayGameState() {
  const key = STORAGE_KEYS.GAME_STATE_PREFIX + todayStr;
  return loadJSON(key, null);
}
function saveTodayGameState(stateObj) {
  const key = STORAGE_KEYS.GAME_STATE_PREFIX + todayStr;
  saveJSON(key, stateObj);
}

/* ---------- CSV LOADING (same as before) ---------- */
async function loadCSVData(file = null) {
  try {
    let csvContent;
    const response = await fetch('birdguessr_db_6nov.csv.csv'); // your filename
    if (!response.ok) throw new Error('CSV file not found');
    csvContent = await response.text();

    const parsed = Papa.parse(csvContent, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true
    });
    return parsed.data;
  } catch (error) {
    console.error('Error loading CSV:', error);
    return [];
  }
}

/* ---------- MAP & UI (unchanged logic but using dailyEntries) ---------- */
function initializeMap(){
  if (map) {
      map.remove();
  }
  map = L.map('map', {
      worldCopyJump: true
  }).setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  map.on('click', handleMapClick);
}

function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ---------- BIRD DISPLAY & ROUND FLOW ---------- */
function parseSpecies(speciesString) {
  if (!speciesString) return [];
  return speciesString.split(',').map(s => s.trim()).filter(s => s.length > 0);
}

function setCurrentBirdFromDaily(index) {
  if (!dailyEntries || index < 0 || index >= dailyEntries.length) return null;
  const e = dailyEntries[index];
  // ensure lat/long types match your original code
  e.lat = parseFloat(e.lat);
  e.lng = parseFloat(e.long ?? e.lng);
  return e;
}

function startNewRound() {
  if (!dailyEntries || dailyEntries.length === 0) {
    console.error('No daily entries available');
    return;
  }

  // if resuming from saved state, currentRound has been loaded already
  const idx = currentRound - 1;
  currentBird = setCurrentBirdFromDaily(idx);
  if (!currentBird) {
    console.error('Could not get daily bird entry for round', currentRound);
    return;
  }

  const species = parseSpecies(currentBird.species);
  birdInfo.scrollTo({ top: 0, behavior: 'smooth' });
  const birdListDiv = document.getElementById('birdList');
  birdListDiv.innerHTML = '';
  species.forEach((bird, index) => {
      const p = document.createElement('p');
      p.className = 'birdItem text-xl font-medium';
      p.style.color = 'var(--accent-gold)';

      const words = bird.trim().split(/\s+/);
      const lastWord = words.pop();
      const rest = words.join(' ');
      if (rest.length > 0) {
          p.innerHTML = `${rest} <span class="bird-lastword">${lastWord}</span>`;
      } else {
          p.innerHTML = `<span class="bird-lastword">${lastWord}</span>`;
      }

      p.style.animationDelay = `${index * 0.005}s`;
      birdListDiv.appendChild(p);
  });

  document.getElementById('birdDate').textContent = currentBird.date || 'Unknown';

  document.getElementById('roundNumber').textContent = currentRound;
  document.getElementById('totalRounds').textContent = totalRounds;
  document.getElementById('totalScore').textContent = totalScore;

  gameState = 'waiting';

  if (playerMarker) {
      map.removeLayer(playerMarker);
      playerMarker = null;
  }
  if (actualMarker) {
      map.removeLayer(actualMarker);
      actualMarker = null;
  }
  if (resultLine) {
      map.removeLayer(resultLine);
      resultLine = null;
  }

  hideOverlay();

  // persist current state (so reload resumes)
  saveTodayGameState({
    currentRound,
    totalScore,
    roundScores,
    completed: false
  });
}

/* ---------- MAP CLICK & CONFIRM ---------- */
function handleMapClick(e) {
  if (gameState !== 'waiting') return;

  const { lat, lng } = e.latlng;

  if (playerMarker) {
      playerMarker.setLatLng([lat, lng]);
  } else {
      playerMarker = L.marker([lat, lng], {
          icon: L.divIcon({
              className: 'custom-div-icon',
              html: '<div style="background-color: #d4af37; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #f0d98c; box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
          })
      }).addTo(map);
  }

  const confirmHandler = () => {
      const distance = calculateDistance(lat, lng, currentBird.lat, currentBird.lng);

      actualMarker = L.marker([currentBird.lat, currentBird.lng], {
          icon: L.divIcon({
              className: 'custom-div-icon',
              html: '<div style="background-color: #3d6b55; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #d4af37; box-shadow: 0 0 10px rgba(61, 107, 85, 0.8);"></div>',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
          })
      }).addTo(map);

      resultLine = L.polyline([[lat, lng], [currentBird.lat, currentBird.lng]], {
          color: '#c9a961',
          weight: 3,
          dashArray: '5, 10'
      }).addTo(map);

      const group = new L.featureGroup([playerMarker, actualMarker]);
      map.fitBounds(group.getBounds().pad(0.1));

      const roundScore = Math.max(0, 1000 - Math.floor(distance / 10));
      totalScore += roundScore;
      roundScores.push({
          distance: distance,
          score: roundScore
      });

      document.getElementById('roundDistance').textContent = Math.round(distance) + ' km';
      document.getElementById('roundScore').textContent = roundScore;
      document.getElementById('overlayTotalScore').textContent = totalScore;
      showOverlay();

      gameState = 'showing-result';

      // persist current round result
      saveTodayGameState({
        currentRound,
        totalScore,
        roundScores,
        completed: (currentRound >= totalRounds)
      });
  };

  const popupContent = `
<div style="text-align:center;">
    <button onclick="window.confirmGuess()" class="popup-confirm-btn">
        Confirm
    </button>
</div>`;

  playerMarker.bindPopup(popupContent).openPopup();

  window.confirmGuess = () => {
      playerMarker.closePopup();
      confirmHandler();
  };
}

/* ---------- OVERLAY / FINAL UI (same as your code) ---------- */
const overlay = document.getElementById("gameOverlay");
const roundInfo = document.getElementById("roundEndInfo");

function showOverlay() {
  overlay.classList.remove("hidden");
  requestAnimationFrame(() => {
      roundInfo.classList.add("roundEndInfo--visible");
  });
}

function hideOverlay() {
  roundInfo.classList.remove("roundEndInfo--visible");
  setTimeout(() => {
      overlay.classList.add("hidden");
  }, 250);
}

function showFinalScoreboard() {
  hideOverlay();

  const today = new Date();
  const dateStr = today.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });

  let shareText = `#BirdGuessr #Day (${dateStr})\n`;
  shareText += `I scored ${totalScore}/${totalRounds * 1000} \n`;

  for (let i = 0; i < roundScores.length; i++) {
      const distKm = roundScores[i].distance >= 1000
          ? `${(roundScores[i].distance / 1000).toFixed(1)}K km`
          : `${Math.round(roundScores[i].distance)} km`;
      shareText += `${i + 1}Ô∏è‚É£ üìç${distKm} - ‚≠ê${roundScores[i].score}/1000\n`;
  }

  const finalOverlay = document.createElement('div');
  finalOverlay.id = 'finalScoreboard';
  finalOverlay.className = 'absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center';
  finalOverlay.style.zIndex = '2000';

  finalOverlay.innerHTML = `
      <div class="rounded-2xl p-12 w-2/3 max-w-2xl shadow-2xl text-center vintage-border" style="background: linear-gradient(135deg, var(--bg-medium-green) 0%, var(--bg-light-green) 100%); color: var(--text-light-cream);">
          <p class="text-6xl font-bold mb-4 glow-text" style="color: var(--accent-light-gold);">${totalScore}</p>
          <p class="text-2xl mb-2" style="color: var(--text-cream);">Total Score</p>
          <p class="text-lg mb-8" style="color: var(--text-cream);">out of ${totalRounds * 1000} points</p>

          <div class="rounded-lg p-4 mb-6 text-left" style="background: rgba(26, 58, 46, 0.6); border: 2px solid var(--accent-bronze);">
              <pre id="shareText" class="text-sm whitespace-pre-wrap font-mono" style="color: var(--text-cream);">${shareText}</pre>
          </div>

          <div class="flex gap-4 justify-center">
              <button onclick="copyScore()" class="vintage-button font-bold py-3 px-6 rounded-lg text-lg">
                  üìã Copy Score
              </button>
              <button onclick="restartGame()" class="vintage-button font-bold py-3 px-6 rounded-lg text-lg">
                  üîÑ Play Again
              </button>
          </div>
      </div>
  `;

  document.getElementById('gameContent').appendChild(finalOverlay);

  // mark saved state as completed
  saveTodayGameState({
    currentRound,
    totalScore,
    roundScores,
    completed: true
  });
}

function copyScore() {
  const shareText = document.getElementById('shareText').textContent;
  navigator.clipboard.writeText(shareText).then(() => {
      const btn = document.querySelector('button[onclick="copyScore()"]');
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úÖ Copied!';
      setTimeout(() => {
          btn.innerHTML = originalText;
      }, 2000);
  }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy. Please select and copy manually.');
  });
}

function restartGame() {
  const finalScoreboard = document.getElementById('finalScoreboard');
  if (finalScoreboard) finalScoreboard.remove();

  // New play should re-use today's dailyEntries but reset score
  currentRound = 1;
  totalScore = 0;
  roundScores = [];

  // persist reset
  saveTodayGameState({ currentRound, totalScore, roundScores, completed: false });

  startNewRound();
}

/* ---------- PAGE NAV & BUTTONS ---------- */
function showPage(pageId) {
  document.getElementById('homePage').classList.add('hidden');
  document.getElementById('gamePage').classList.add('hidden');
  document.getElementById(pageId).classList.remove('hidden');
}

document.getElementById('startGameBtn').addEventListener('click', () => {
  if (dailyEntries.length === 0) {
      alert('Game not ready!');
      return;
  }

  // load saved state if exists
  const saved = loadTodayGameState();
  if (saved && saved.completed) {
      // Show final scoreboard for completed game
      currentRound = saved.currentRound || totalRounds;
      totalScore = saved.totalScore || 0;
      roundScores = saved.roundScores || [];
      showPage('gamePage');
      initializeMap();
      // show final immediately
      showFinalScoreboard();
      return;
  } else if (saved) {
      // resume
      currentRound = saved.currentRound || 1;
      totalScore = saved.totalScore || 0;
      roundScores = saved.roundScores || [];
  } else {
      currentRound = 1;
      totalScore = 0;
      roundScores = [];
  }

  showPage('gamePage');
  initializeMap();
  startNewRound();
});

document.getElementById('homeBtn').addEventListener('click', () => {
  showPage('homePage');
});

document.getElementById('nextRoundBtn').addEventListener('click', () => {
  currentRound++;
  if (currentRound <= totalRounds) {
      startNewRound();
  } else {
      showFinalScoreboard();
  }
});

/* ---------- BOOTSTRAP / DOMContentLoaded ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const startBtn = document.getElementById('startGameBtn');
  startBtn.disabled = true;

  csvData = await loadCSVData();
  if (csvData.length > 0) {
    // Create today's set (persisted)
    ensureDailyEntries(csvData);
    // if dailyEntries are available, allow starting
    if (dailyEntries && dailyEntries.length === ROUNDS_PER_DAY) {
      console.log('Daily entries ready:', dailyEntries.length);
      startBtn.disabled = false;
    } else {
      console.error('Not enough daily entries');
      alert('Not enough valid entries in CSV to form today\'s game.');
    }
  } else {
    console.error('CSV load returned zero rows');
    alert('Failed to load bird CSV data.');
  }
  // If a saved game exists for today and completed, set start disabled? we still allow replay
});
</script>

</body>
</html>
